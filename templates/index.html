{% extends "base.html" %}
{% block title %}{{ title }} - 云域通{% endblock %}

{% block content %}
  {% if current_user.is_authenticated %}
    <h1>欢迎回来, {{ current_user.username }}!</h1>
    <p>这里是你的云域通主面板。</p>
    {# 添加 Token 按钮 #}
    <a href="{{ url_for('add_token') }}" class="btn btn-primary mt-3 mb-3">添加 Cloudflare API Token</a>

    {# 显示 Token 列表 #}
    {% if tokens %}
      <h3>已添加的 API Tokens:</h3>
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th scope="col">名称</th>
            <th scope="col">备注</th>
            <th scope="col">添加时间</th>
            <th scope="col">状态</th>
            <th scope="col">操作</th>
          </tr>
        </thead>
        <tbody>
          {% for token in tokens %}
          <tr>
            <td>{{ token.name }}</td>
            <td>
              {# 显示备注 #}
              {% if token.remarks %}
                <span class="d-block text-muted small">{{ token.remarks | truncate(50) }}</span>
              {% else %}
                <span class="d-block text-muted small">-</span>
              {% endif %}
              {# 添加域名预览 #}
              {% if token.domains %}
              <div class="mt-1" style="font-size: 0.8em; color: #6c757d;">
                  <strong>域名预览:</strong>
                  {{ token.domains | map(attribute='name') | list | join(', ') | truncate(80) }}
              </div>
              {% endif %}
            </td>
            <td>{{ token.added_at.strftime('%Y-%m-%d %H:%M:%S') if token.added_at else 'N/A' }}</td>
            <td>
              {# 可以根据 token.status 显示不同样式 #}
              <span class="badge
                {% if token.status == 'valid' %} bg-success
                {% elif token.status == 'invalid' %} bg-danger
                {% else %} bg-secondary
                {% endif %}">
                {{ token.status }}
              </span>
            </td>
            <td>
              {# 查看域名按钮 #}
              <a href="{{ url_for('view_domains', token_id=token.id) }}" class="btn btn-sm btn-info me-1">查看域名</a>

              {# 验证按钮 #}
              <form action="{{ url_for('verify_token', token_id=token.id) }}" method="POST" style="display: inline;">
                <button type="submit" class="btn btn-sm btn-warning me-1">验证</button>
              </form>

              {# 删除按钮 #}
              <form action="{{ url_for('delete_token', token_id=token.id) }}" method="POST" style="display: inline;"
                    onsubmit="return confirm('确定要删除这个 API Token \'{{ token.name }}\' 吗？\n注意：所有通过此 Token 获取的域名和 DNS 记录缓存也将被删除！');">
                   {# <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/> #}
                   <button type="submit" class="btn btn-sm btn-danger">删除</button>
              </form>

              <a href="{{ url_for('edit_token', token_id=token.id) }}" class="btn btn-sm btn-secondary me-1">编辑</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="text-muted mt-4">你还没有添加任何 API Token。</p>
    {% endif %}

  {% else %}
    <h1>欢迎来到云域通</h1>
    <p>请 <a href="{{ url_for('login') }}">登录</a> 或 <a href="{{ url_for('register') }}">注册</a> 以开始管理您的 Cloudflare 域名。</p>
  {% endif %}
{% endblock %} 